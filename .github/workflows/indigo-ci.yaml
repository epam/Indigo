name: Indigo CI

env:
  OS_NAME_MAPPING_JSON: '{"ubuntu-latest": "linux", "windows-latest": "windows", "macos-13": "macos"}'

on:
  push:
    branches:
      - master
    tags:
      - 'indigo-*'
  workflow_dispatch:
  pull_request:
  repository_dispatch:

jobs:
  publish_indigo_to_maven:
    runs-on: ubuntu-latest
    container: epmlsop/indigo-tester:latest
    steps:
      - name: Publish Java jars to Maven Central
        env:
          MAVEN_SETTINGS: ${{ secrets.MAVEN_SETTINGS }}
          MAVEN_USER: ${{ secrets.MAVEN_USER }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_PRIVATE_KEY: ${{ secrets.MK_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.MK_GPG_PASSPHRASE }}
        run: |
          pwd
          set -eux
          mkdir /root/.m2
          echo ${MAVEN_SETTINGS} > /root/.m2/settings.xml
          base64 /root/.m2/settings.xml
          echo ${GPG_PRIVATE_KEY} > gpg.key
          base64 gpg.key
          echo ${GPG_PASSPHRASE} > gpg.pass
          base64 gpg.pass
