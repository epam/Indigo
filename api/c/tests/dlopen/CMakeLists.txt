cmake_minimum_required(VERSION 3.6)

project(indigo-dlopen-tests LANGUAGES C)

if (ENABLE_TESTS)
    if(NOT CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fsanitize=address -fsanitize=leak -g")
        set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fsanitize=address -fsanitize=leak -g")
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -fsanitize=address -fsanitize=leak")
        set(CMAKE_MODULE_LINKER_FLAGS "${CMAKE_MODULE_LINKER_FLAGS} -fsanitize=address -fsanitize=leak")
        set(CMAKE_CXX_COMPILER_LAUNCHER ${CMAKE_COMMAND} -E env ASAN_OPTIONS=strict_string_checks=1:detect_stack_use_after_return=1:check_initialization_order=1:strict_init_order=1)
    endif()
    add_executable(${PROJECT_NAME} ${CMAKE_CURRENT_SOURCE_DIR}/indigo-test-dlopen.c)
    target_link_libraries(${PROJECT_NAME} ${CMAKE_DL_LIBS})
    add_test(NAME ${PROJECT_NAME}-indigo
            COMMAND $ENV{INDIGO_QEMU_BINARY} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${PROJECT_NAME} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}indigo${CMAKE_SHARED_LIBRARY_SUFFIX})
    add_test(NAME ${PROJECT_NAME}-indigo-inchi
            COMMAND $ENV{INDIGO_QEMU_BINARY} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${PROJECT_NAME} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}indigo${CMAKE_SHARED_LIBRARY_SUFFIX} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}indigo-inchi${CMAKE_SHARED_LIBRARY_SUFFIX})
    add_test(NAME ${PROJECT_NAME}-indigo-renderer
            COMMAND $ENV{INDIGO_QEMU_BINARY} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${PROJECT_NAME} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}indigo${CMAKE_SHARED_LIBRARY_SUFFIX} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}indigo-renderer${CMAKE_SHARED_LIBRARY_SUFFIX})
    add_test(NAME ${PROJECT_NAME}-bingo-nosql
            COMMAND $ENV{INDIGO_QEMU_BINARY} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${PROJECT_NAME} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}indigo${CMAKE_SHARED_LIBRARY_SUFFIX} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${CMAKE_SHARED_LIBRARY_PREFIX}bingo-nosql${CMAKE_SHARED_LIBRARY_SUFFIX})
endif()
