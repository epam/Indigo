/****************************************************************************
 * Copyright (C) from 2009 to Present EPAM Systems.
 *
 * This file is part of Indigo toolkit.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ***************************************************************************/

#include "molecule/molecule_ionize.h"
#include "base_cpp/output.h"
#include "base_cpp/queue.h"
#include "base_cpp/scanner.h"
#include "molecule/base_molecule.h"
#include "molecule/elements.h"
#include "molecule/molecule.h"
#include "molecule/molecule_automorphism_search.h"
#include "molecule/molecule_substructure_matcher.h"
#include "molecule/molfile_loader.h"
#include "molecule/molfile_saver.h"
#include "molecule/query_molecule.h"
#include "molecule/sdf_loader.h"
#include "molecule/smiles_loader.h"

using namespace indigo;

MoleculePkaModel MoleculePkaModel::_model;

IMPL_ERROR(MoleculePkaModel, "Molecule Pka Model");

MoleculePkaModel::MoleculePkaModel()
{
    //   _loadSimplePkaModel();
    //   _loadAdvancedPkaModel();
}

void MoleculePkaModel::estimate_pKa(Molecule& mol, const IonizeOptions& options, Array<int>& acid_sites, Array<int>& basic_sites, Array<float>& acid_pkas,
                                    Array<float>& basic_pkas)
{
    if (options.model == IonizeOptions::PKA_MODEL_SIMPLE)
    {
        if (!_model.simple_model_ready)
            _loadSimplePkaModel();
        _estimate_pKa_Simple(mol, options, acid_sites, basic_sites, acid_pkas, basic_pkas);
    }
    else if (options.model == IonizeOptions::PKA_MODEL_ADVANCED)
    {
        if (!_model.advanced_model_ready)
            _loadAdvancedPkaModel();
        _estimate_pKa_Advanced(mol, options, acid_sites, basic_sites, acid_pkas, basic_pkas);
    }
    else
        throw Error("Unsupported pKa model: %d", options.model);
}

int MoleculePkaModel::buildPkaModel(int max_level, float threshold, const char* filename)
{
    //   QS_DEF(Array<int>, order);
    //   QS_DEF(Molecule, can_mol);
    QS_DEF(Array<char>, fp);
    RedBlackStringObjMap<Array<float>> acid_pkas;
    RedBlackStringObjMap<Array<float>> basic_pkas;
    RedBlackStringObjMap<Array<int>> acid_pka_cids;
    RedBlackStringObjMap<Array<int>> basic_pka_cids;
    AromaticityOptions opts;

    const char* a_pka_sites_id = "ACID PKA SITES";
    const char* a_pka_values_id = "ACID PKA VALUES";
    const char* b_pka_sites_id = "BASIC PKA SITES";
    const char* b_pka_values_id = "BASIC PKA VALUES";
    const char* compound_cid = "PUBCHEM_COMPOUND_CID";

    Molecule mol;
    int level = 0;

    _model.adv_a_pkas.clear();
    _model.adv_b_pkas.clear();

    for (;;)
    {
        FileScanner scanner(filename);
        SdfLoader loader(scanner);

        int a_count = 0;
        int b_count = 0;
        acid_pkas.clear();
        basic_pkas.clear();
        acid_pka_cids.clear();
        basic_pka_cids.clear();

        int mol_count = 0;
        while (!loader.isEOF())
        {
            mol_count++;
            loader.readNext();
            BufferScanner scanner(loader.data);
            MolfileLoader mol_loader(scanner);
            mol_loader.stereochemistry_options.ignore_errors = true;
            mol_loader.loadMolecule(mol);

            int cid = 0;
            if (loader.properties.contains(compound_cid))
            {
                BufferScanner scan_cid(loader.properties.at(compound_cid));
                cid = scan_cid.readInt();
            }

            //         mol.aromatize(opts);
            //         _checkCanonicalOrder(mol, can_mol, order);
            _removeExtraHydrogens(mol);

            if (loader.properties.contains(a_pka_sites_id))
            {
                const char* aids = loader.properties.at(a_pka_sites_id);
                const char* apkas = loader.properties.at(a_pka_values_id);

                BufferScanner scan_aids(aids);
                Array<int> a_sites;
                while (!scan_aids.isEOF())
                {
                    int idx = scan_aids.readInt1() - 1;
                    a_sites.push(idx);
                }
                BufferScanner scan_apka(apkas);
                Array<float> a_pka;
                while (!scan_apka.isEOF())
                {
                    float val = scan_apka.readFloat();
                    a_pka.push(val);
                }

                if (a_sites.size() > 1)
                {
                    //               printf("Warning: multiple acid sites detected. Skip this compound (%d)\n", cid);
                }
                else
                {
                    for (int i = 0; i < a_sites.size(); i++)
                    {
                        fp.clear();
                        //                  int idx = order.find(a_sites[i]);
                        int idx = a_sites[i];
                        float val = a_pka[i];

                        getAtomLocalFingerprint(mol, idx, fp, level);

                        if (fp.size() == 0)
                            continue;

                        if (!acid_pkas.find(fp.ptr()))
                        {
                            acid_pkas.insert(fp.ptr());
                            acid_pka_cids.insert(fp.ptr());
                            a_count++;
                        }
                        acid_pkas.at(fp.ptr()).push(val);
                        acid_pka_cids.at(fp.ptr()).push(cid);
                    }
                }
            }

            if (loader.properties.contains(b_pka_sites_id))
            {

                const char* bids = loader.properties.at(b_pka_sites_id);
                const char* bpkas = loader.properties.at(b_pka_values_id);

                BufferScanner scan_bids(bids);
                Array<int> b_sites;
                while (!scan_bids.isEOF())
                {
                    int idx = scan_bids.readInt1() - 1;
                    b_sites.push(idx);
                }
                BufferScanner scan_bpka(bpkas);
                Array<float> b_pka;
                while (!scan_bpka.isEOF())
                {
                    float val = scan_bpka.readFloat();
                    b_pka.push(val);
                }

                if (b_sites.size() > 1)
                {
                    //               printf("Warning: multiple protonation sites detected. Skip this compound (%d)\n", cid);
                }
                else
                {
                    for (int i = 0; i < b_sites.size(); i++)
                    {
                        fp.clear();
                        //                  int idx = order.find(b_sites[i]);
                        int idx = b_sites[i];
                        float val = b_pka[i];

                        getAtomLocalFingerprint(mol, idx, fp, level);

                        if (fp.size() == 0)
                            continue;

                        if (!basic_pkas.find(fp.ptr()))
                        {
                            basic_pkas.insert(fp.ptr());
                            basic_pka_cids.insert(fp.ptr());
                            b_count++;
                        }
                        basic_pkas.at(fp.ptr()).push(val);
                        basic_pka_cids.at(fp.ptr()).push(cid);
                    }
                }
            }
        }

        bool model_ready = true;
        float max_deviation = 0.f;

        for (int i = 0; i < acid_pkas.size(); i++)
        {
            const char* fp = acid_pkas.key(i);
            Array<float>& pkas = acid_pkas.value(i);
            float pka_sum = 0.f;
            float pka_dev = 0.f;
            float pka_min = 100.f;
            float pka_max = -100.f;
            for (int k = 0; k < pkas.size(); k++)
            {
                float val = pkas.at(k);
                pka_sum = pka_sum + val;
                if (pka_min > val)
                    pka_min = val;
                if (pka_max < val)
                    pka_max = val;
            }

            if ((pka_max - pka_sum / pkas.size()) > (pka_sum / pkas.size() - pka_min))
                pka_dev = pka_max - pka_sum / pkas.size();
            else
                pka_dev = pka_sum / pkas.size() - pka_min;

            if (pka_dev > max_deviation)
                max_deviation = pka_dev;

            if (_model.adv_a_pkas.find(fp))
                _model.adv_a_pkas.remove(fp);
            _model.adv_a_pkas.insert(fp);
            _model.adv_a_pkas.at(fp).push(pka_sum / pkas.size());
            _model.adv_a_pkas.at(fp).push(pka_dev);

            if (pka_dev > threshold)
                model_ready = false;
        }

        for (int i = 0; i < basic_pkas.size(); i++)
        {
            const char* fp = basic_pkas.key(i);
            Array<float>& pkas = basic_pkas.value(i);
            float pka_sum = 0.f;
            float pka_dev = 0.f;
            float pka_min = 100.f;
            float pka_max = -100.f;
            for (int k = 0; k < pkas.size(); k++)
            {
                float val = pkas.at(k);
                pka_sum = pka_sum + val;
                if (pka_min > val)
                    pka_min = val;
                if (pka_max < val)
                    pka_max = val;
            }

            if ((pka_max - pka_sum / pkas.size()) > (pka_sum / pkas.size() - pka_min))
                pka_dev = pka_max - pka_sum / pkas.size();
            else
                pka_dev = pka_sum / pkas.size() - pka_min;

            if (pka_dev > max_deviation)
                max_deviation = pka_dev;

            if (_model.adv_b_pkas.find(fp))
                _model.adv_b_pkas.remove(fp);
            _model.adv_b_pkas.insert(fp);
            _model.adv_b_pkas.at(fp).push(pka_sum / pkas.size());
            _model.adv_b_pkas.at(fp).push(pka_dev);

            if (pka_dev > threshold)
                model_ready = false;
        }

        if (model_ready)
        {
            break;
        }
        else
        {
            if (level >= max_level)
            {
                level = -1;
                break;
            }
            else
            {
                level++;
                _model.max_deviations.push(max_deviation);
            }
        }
    }

    _model.level = level;
    _model.advanced_model_ready = true;

    return level;
}

namespace // data of internal purpose
{
    struct SimplePkaDef
    {
        const char* acid;
        float pka;
        const char* basic;
    };

    /*  Roger Sayle, Physiological ionization and pKa prediction,
     *   http://www.daylight.com/meetings/emug00/Sayle/pkapredict.html
     */
    constexpr SimplePkaDef simple_pka_model[] = {
        {"[F;!H0]", 3.18f, "[F-]"},
        {"[Cl;!H0]", -6.50f, "[Cl-]"},
        {"[Br;!H0]", -8.50f, "[Br-]"},
        {"[I;!H0]", -9.00f, "[I-]"},
        {"[c;!H0]", 43.00f, "[c-]"},
        {"[$([C]#N);!H0]", 9.30f, "[$([C-]#N)]"},
        {"[C;!H0]", 50.00f, "[C-]"},
        {"[nH;!H0]", 16.50f, "[n-]"},
        {"[$([N]=N=*);!H0]", -99.99f, "[$([N-]=N=*)]"},
        {"[$([N]C=O);!H0]", 22.00f, "[$([N-]C=O)]"},
        {"[$([N]S(=O)=O);!H0]", 10.10f, "[$([N-]S(=O)=O)]"},
        {"[N;!H0]", 32.50f, "[N-]"},
        {"[nH2+;!H0]", -3.80f, "[nH]"},
        {"[nH+;!H0]", 5.23f, "[n]"},
        {"[$([NH+]#*);!H0]", -12.00f, "[$([N]#*)]"},
        {"[$([NH+]=C(N)N);!H0]", 14.4f, "[$([N]=C(N)N)]"},
        {"[$([NH+]=C(N)a);!H0]", 11.6f, "[$([N]=C(N)a)]"},
        {"[$([NH+]=CN);!H0]", 12.4f, "[$([N]=CN)]"},
        {"[$([NH+]=*);!H0]", -99.99f, "[$([N]=*)]"},
        {"[$([NH+]a);!H0]", 4.69f, "[$([N]a)]"},
        {"[$([NH+]C=O);!H0]", 4.74f, "[$([N]C=O)]"},
        {"[$([NH+]C=N);!H0]", -99.99f, "[$([N]C=N)]"},
        {"[$([NH+]S(=O)=O);!H0]", -99.99f, "[$([N]S(=O)=O)]"},
        {"[NH+;!H0]", 10.5f, "[N]"},
        {"[NH2+;!H0]", 11.1f, "[$([N](C)C)]"},
        {"[NH3+;!H0]", 10.6f, "[NH2]"},
        {"[NH4+;!H0]", 9.25f, "[NH3]"},
        {"[OH2;!H0]", 15.70f, "[OH-]"},
        {"[$([O]c);!H0]", 10.00f, "[O-]a"},
        {"[$([O]C(=O)[O-]);!H0]", 10.33f, "[$([O-]C(=O)[O-])]"},
        {"[$([O]C(=O)a);!H0]", 4.20f, "[$([O-]C(=O)a)]"},
        {"[$([O]C=O);!H0]", 4.80f, "[$([O-]C=O)]"},
        {"[$([O]C);!H0]", 15.50f, "[$([O-]C)]"},
        {"[$([O]N(=O)=O);!H0]", -1.40f, "[$([O-]N(=O)=O)]"},
        {"[$([O][N+]=O);!H0]", -12.00f, "[$([O-][N+]=O)]"},
        {"[$([O]NC=O);!H0]", 9.40f, "[$([O-]NC=O)]"},
        {"[$([O]N=*);!H0]", 12.34f, "[$([O-]N=*)]"},
        {"[$([O]N(*)*);!H0]", 5.2f, "[$([O-]N(*)*)]"},
        {"[$([O]N);!H0]", 5.96f, "[$([O-]N)]"},
        {"[$([O]P([O-])([O-]));!H0]", 12.50f, "[$([O-]P([O-])([O-]))]"},
        {"[$([O]P([O-])=O);!H0]", 6.70f, "[$([O-]P([O-])=O)]"},
        {"[$([O]P=O);!H0]", 2.00f, "[$([O-]P=O)]"},
        {"[$([O]P[O-]);!H0]", 99.99f, "[$([O-]P[O-])]"},
        {"[$([O]Pa);!H0]", 2.10f, "[$([O-]Pa)]"},
        {"[$([O]P);!H0]", 3.08f, "[$([O-]P)]"},
        {"[$([O]S(=O)(=O)[O-]);!H0]", 2.0f, "[$([O-]S(=O)(=O)[O-])]"},
        {"[$([O]S(=O)(=O));!H0]", -99.99f, "[$([O-]S(=O)(=O))]"},
        {"[$([O]S(=O)[O-]);!H0]", 7.20f, "[$([O-]S(=O)[O-])]"},
        {"[$([O]S(=O));!H0]", 1.80f, "[$([O-]S(=O))]"},
        {"[O;!H0]", 99.99f, "[O-]"},
        {"[OH+;!H0]", -1.74f, "[O]"},
        {"[P;!H0]", 29.00f, "[P-]"},
        {"[P+;!H0]", -13.00f, "[P]"},
        {"[$([S]*=O);!H0]", 3.52f, "[$([S-]*=O)]"},
        {"[$([S]a);!H0]", 6.52f, "[$([S-]a)]"},
        {"[SH2;!H0]", 7.00f, "[SH-]"},
        {"[S;!H0]", 12.00f, "[S-]"},
        {"[SH+;!H0]", -7.00f, "[S]"},
    };
} // namespace

void MoleculePkaModel::_loadSimplePkaModel()
{
    _model.acids.clear();
    _model.basics.clear();
    _model.a_pkas.clear();
    _model.b_pkas.clear();

    for (auto i = 0; i < NELEM(simple_pka_model); i++)
    {
        BufferScanner scanner(simple_pka_model[i].acid);
        SmilesLoader loader(scanner);
        QueryMolecule& acid = _model.acids.push();
        loader.loadSMARTS(acid);
        _model.a_pkas.push(simple_pka_model[i].pka);
    }

    for (auto i = 0; i < NELEM(simple_pka_model); i++)
    {
        BufferScanner scanner(simple_pka_model[i].basic);
        SmilesLoader loader(scanner);
        QueryMolecule& basic = _model.basics.push();
        loader.loadSMARTS(basic);
        _model.b_pkas.push(simple_pka_model[i].pka);
    }

    _model.simple_model_ready = true;
}

namespace // data of internal purpose
{
    struct AdvancedPkaDef
    {
        const char* a_fp;
        float pka;
        float deviation;
    };

    // These are basics
    constexpr AdvancedPkaDef advanced_pka_model_basic[] = {
        {"7300021310000", 7.52f, 7.77f},
        {"7300021320000", 7.77f, 11.57f},
        {"7300021311000", 5.39f, 8.91f},
        {"7300021330000", 7.84f, 6.14f},
        {"82-10023110000", 4.65f, 0.00f},
        {"7410020421000", 0.79f, 0.00f},
        {"7410020410000", 8.86f, 0.00f},
        {"7300021310000|6400020430000", 9.33f, 2.06f},
        {"7300021310000|6400020420000", 9.93f, 4.59f},
        {"7300021320000|64000204200006400020430000", 10.12f, 1.48f},
        {"7300021310000|6400020410000", 10.66f, 0.00f},
        {"7300021310000|8200022220000", 12.50f, 0.00f},
        {"7300021311000|6400020421000", 11.15f, 6.54f},
        {"7300021320000|64000204200006400020420000", 10.27f, 2.23f},
        {"7300021320000|64000204100006400020410000", 10.73f, 0.00f},
        {"7300021311000|64000204210006400020421000", 5.83f, 5.69f},
        {"7300021311000|64000204110006400020411000", 5.07f, 6.98f},
        {"7300021311000|64000204110008200022220000", -2.00f, 0.00f},
        {"7300021311000|64000204110007300021320000", 2.49f, 0.00f},
        {"7300021311000|64000204110006400020421000", 5.34f, 7.34f},
        {"7300021320000|64000204100006400020420000", 9.42f, 1.22f},
        {"7300021330000|640002041000064000204100006400020410000", 9.80f, 0.00f},
        {"82-10023110000|7410020440000", 4.65f, 0.00f},
        {"7300021311000|64000204110007300021311000", 2.86f, 0.62f},
        {"7300021320000|64000204210006400020421000", 5.05f, 5.36f},
        {"7300021320000|64000204110006400020411000", -0.30f, 3.50f},
        {"7300021310000|6400020440000", 10.01f, 1.71f},
        {"7300021330000|640002041000064000204100006400020420000", 9.42f, 1.17f},
        {"7300021320000|64000204110006400020421000", 3.95f, 3.20f},
        {"7410020421000|6400020411000640002041100082-10023110000", 0.79f, 0.00f},
        {"7300021330000|640002041000064000204200006400020420000", 9.00f, 2.16f},
        {"7300021330000|640002041000064000204100006400020421000", 5.97f, 6.03f},
        {"7300021310000|6400020421000", 3.71f, 6.28f},
        {"7300021311000|64000204210007300021320000", 1.60f, 0.00f},
        {"7300021310000|7300021320000", 8.79f, 0.00f},
        {"7300021330000|640002042000064000204200006400020420000", 8.74f, 2.18f},
        {"7300021330000|640002041000064000204200006400020430000", 8.30f, 3.08f},
        {"7300021320000|64000204300006400020430000", 10.73f, 0.33f},
        {"7300021320000|1440002044000014400020440000", 7.55f, 0.00f},
        {"7300021320000|166000206220006400020421000", 11.68f, 0.00f},
        {"7300021320000|64000204100006400020421000", 4.26f, 0.59f},
        {"7300021311000|64000204210007300021311000", 2.37f, 0.00f},
        {"7300021320000|64000204200006400020421000", 4.47f, 0.65f},
        {"7300021330000|640002041000064000204300006400020430000", 6.75f, 2.95f},
        {"7300021320000|64000204100006400020430000", 10.36f, 0.63f},
        {"7300021320000|64000204210006400020430000", 9.06f, 3.30f},
        {"7300021320000|64000204400006400020440000", 11.07f, 0.00f},
        {"7300021320000|64000204210006400020440000", 7.00f, 0.00f},
        {"7300021330000|640002042000064000204200006400020421000", 8.68f, 3.54f},
        {"7300021311000|64000204200006400020421000", 9.58f, 0.00f},
        {"7300021330000|640002041000064000204400006400020440000", 11.25f, 0.00f},
        {"7300021311000|64000204110006400020420000", 5.20f, 0.00f},
        {"7300021311000|64000204210006400020430000", 8.76f, 0.00f},
        {"7410020410000|6400020430000", 8.86f, 0.00f},
        {"7300021330000|640002042100064000204210008200022210000", 5.50f, 0.00f},
        {"7300021311000|64000204210006400020440000", 2.00f, 0.10f},
        {"7300021320000|64000204100006400020440000", 7.50f, 0.00f},
        {"7300021330000|640002041000064000204210006400020421000", 3.40f, 0.00f},
        {"7300021311000|64000204100006400020421000", 4.80f, 0.00f},
        {"7300021330000|640002042000064000204210006400020421000", 1.70f, 0.00f},
        {"7300021320000|64000204200006400020440000", 9.67f, 0.00f},
        {"7300021330000|640002042100064000204210007300021330000", 4.50f, 0.00f},
        {"7300021330000|640002042100064000204210006400020430000", 8.26f, 0.00f},
        {"7300021330000|640002042000064000204200006400020430000", 8.19f, 4.01f},
        {"7300021330000|640002041000064000204100006400020430000", 8.80f, 0.00f},
        {"7300021320000|64000204110007300021330000", 1.70f, 0.00f},
        {"7300021330000|640002042000064000204300006400020430000", 6.66f, 0.00f},
        {"7300021310000|6400020430000|640002042000064000204210007300021310000", 9.21f, 1.61f},
        {"7300021310000|6400020420000|64000204210007300021310000", 8.73f, 1.05f},
        {"7300021310000|6400020430000|640002042100064000204300007300021310000", 9.53f, 0.43f},
        {"7300021320000|64000204200006400020430000|6400020420000730002132000064000204200006400020421000", 10.67f, 0.05f},
        {"7300021310000|6400020410000|7300021310000", 10.66f, 0.00f},
        {"7300021310000|8200022220000|64000204100007300021310000", 12.50f, 0.00f},
        {"7300021311000|6400020421000|730002131100073000213100007300021310000", 13.60f, 0.00f},
        {"7300021310000|6400020420000|64000204100107300021310000", 5.34f, 0.00f},
        {"7300021320000|64000204200006400020420000|7300021320000", 8.04f, 0.00f},
        {"7300021311000|6400020421000|640002041000073000213100007300021311000", 12.10f, 0.00f},
        {"7300021310000|6400020420000|64000204100007300021310000", 10.65f, 0.00f},
        {"7300021320000|64000204100006400020410000|7300021320000", 10.73f, 0.00f},
        {"7300021310000|6400020420000|64000204200007300021310000", 10.36f, 2.56f},
        {"7300021311000|64000204210006400020421000|73000213100007300021310000730002131100073000213100007300021311000", 11.52f, 0.00f},
        {"7300021311000|64000204110006400020411000|640002041100073000213110008200022220000", 0.80f, 0.00f},
        {"7300021311000|64000204110008200022220000|640002041100073000213110006400020411000", -2.00f, 0.00f},
        {"7300021311000|64000204110006400020411000|1620002222000073000213110006400020411000", 2.52f, 0.00f},
        {"7300021311000|64000204110007300021320000|640002041100073000213110006400020411000", 2.49f, 0.00f},
        {"7300021311000|64000204110006400020411000|640002041100073000213110007300021320000", 6.99f, 0.00f},
        {"7300021311000|64000204110006400020421000|64000204110007300021311000162000222200007300021310000", 5.36f, 0.00f},
        {"7300021311000|64000204210006400020421000|73000213100007300021311000730002131100073000213100007300021311000", 5.00f, 0.00f},
        {"7300021310000|6400020420000|64000204110007300021310000", 9.49f, 0.00f},
        {"7300021320000|64000204200006400020420000|64000204200007300021320000", 11.29f, 0.00f},
        {"7300021320000|64000204100006400020420000|73000213200006400020421000", 10.10f, 0.00f},
        {"7300021310000|6400020430000|640002041000064000204100007300021310000", 10.63f, 0.00f},
        {"7300021330000|640002041000064000204100006400020410000|7300021330000", 9.80f, 0.00f},
        {"82-10023110000|7410020440000|64000204100006400020410000640002041000082-10023110000", 4.65f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020421000730002131100073000213200008200022201000", 3.26f, 0.00f},
        {"7300021311000|64000204110006400020411000|640002041100073000213110006400020411000", 5.54f, 6.51f},
        {"7300021311000|64000204110006400020411000|640002041100073000213110007300021311000", 1.23f, 0.00f},
        {"7300021311000|64000204110007300021311000|640002041100073000213110006400020411000", 2.24f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204110007300021320000820002220100073000213200008200022201000", 9.45f, 0.00f},
        {"7300021311000|64000204210006400020421000|73000213100007300021311000730002131100064000204110007410020421000", 0.35f, 0.00f},
        {"7300021320000|64000204110006400020411000|640002041100073000213200006400020411000", -0.30f, 3.50f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100073000213100007300021311000", 3.45f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002131100064000204110007300021310000", 5.71f, 0.00f},
        {"7300021311000|64000204110006400020411000|640002041100073000213110007300021330000", 6.95f, 0.00f},
        {"7300021320000|64000204200006400020420000|640002042100073000213200006400020421000", 9.89f, 0.00f},
        {"7300021311000|64000204210006400020421000|73000213100007300021311000730002133000064000204200008200022201000", 9.20f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110007300021310000730002131100073000213100007300021311000", 6.84f, 0.00f},
        {"7300021320000|64000204200006400020420000|640002042000073000213200006400020420000", 10.55f, 2.05f},
        {"7300021310000|6400020440000|6400020410000640002041000064000204210007300021310000", 10.21f, 0.00f},
        {"7300021330000|640002041000064000204100006400020420000|73000213300006400020421000", 9.89f, 0.00f},
        {"7300021311000|6400020421000|730002131000073000213110007300021330000", 14.30f, 0.00f},
        {"7300021310000|6400020430000|640002041000064000204200007300021310000", 10.63f, 0.07f},
        {"7300021310000|6400020440000|6400020410000640002041000064000204100007300021310000", 10.68f, 0.00f},
        {"7300021320000|64000204200006400020420000|640002041000073000213200006400020410000", 10.84f, 0.00f},
        {"7300021310000|6400020440000|6400020420000640002042000064000204200007300021310000", 8.30f, 0.00f},
        {"7300021311000|64000204110006400020411000|640002041100073000213110006400020421000", 5.19f, 4.46f},
        {"7300021311000|64000204110006400020421000|64000204110007300021311000171000231100006400020411000", 0.49f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110009100023110000", -0.44f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002132000064000204210007300021320000", 8.70f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002131100064000204210007300021320000", 10.20f, 0.00f},
        {"7300021320000|64000204110006400020421000|6400020411000730002132000064000204110008200022201000", 0.75f, 0.00f},
        {"7410020421000|6400020411000640002041100082-10023110000|640002041100074100204210006400020411000", 0.79f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110006400020421000", 4.86f, 4.36f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110007300021310000", 6.82f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204100006400020411000", 4.81f, 3.36f},
        {"7300021311000|64000204110006400020421000|6400020421000730002131100064000204110007300021310000", 5.77f, 0.72f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110007300021320000", 3.39f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020421000730002131100064000204100007300021320000", 8.36f, 0.00f},
        {"7300021320000|64000204200006400020430000|6400020430000730002132000064000204200006400020421000", 9.66f, 0.00f},
        {"7300021330000|640002041000064000204200006400020420000|730002133000064000204200006400020420000", 9.20f, 1.82f},
        {"7300021320000|64000204200006400020420000|640002042000073000213200006400020421000", 10.19f, 0.00f},
        {"7300021330000|640002041000064000204100006400020421000|730002133000073000213300008200022201000", 12.00f, 0.00f},
        {"7300021310000|6400020430000|640002042000064000204200007300021310000", 10.61f, 0.03f},
        {"7300021310000|6400020440000|6400020410000640002041000064000204200007300021310000", 10.85f, 0.00f},
        {"7300021330000|640002041000064000204100006400020420000|73000213300006400020420000", 9.27f, 1.02f},
        {"7300021330000|640002041000064000204200006400020420000|730002133000064000204100006400020410000", 10.35f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002131100064000204210007300021311000", 4.05f, 0.00f},
        {"7300021310000|6400020421000|640002041100064000204110007300021310000", 3.74f, 2.72f},
        {"7300021310000|6400020421000|640002041100064000204210007300021310000", 3.23f, 3.48f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110006400020411000", 12.68f, 0.00f},
        {"7300021311000|64000204210007300021320000|6400020411000640002042100073000213110007300021311000", 1.60f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204210007300021320000", 2.27f, 0.00f},
        {"7300021320000|64000204110006400020421000|6400020411000730002132000064000204110006400020411000", 3.59f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110008200022220000", 3.28f, 0.00f},
        {"7300021310000|7300021320000|64000204210007300021310000", 8.79f, 0.00f},
        {"7300021330000|640002042000064000204200006400020420000|6400020421000730002133000064000204210006400020421000", 10.70f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204100006400020411000730002131100073000213100007300021311000", 4.82f, 0.00f},
        {"7300021330000|640002041000064000204200006400020430000|7300021330000640002042000064000204100006400020420000", 10.21f, 0.01f},
        {"7300021330000|640002042000064000204200006400020420000|6400020410000730002133000064000204200006400020420000", 9.06f, 1.39f},
        {"7300021330000|640002042000064000204200006400020420000|6400020420000730002133000064000204200006400020421000", 8.35f, 0.00f},
        {"7300021320000|64000204300006400020430000|64000204100006400020410000730002132000064000204100006400020410000", 11.05f, 0.00f},
        {"7300021330000|640002042000064000204200006400020420000|6400020410000730002133000064000204100006400020410000", 10.75f, 0.00f},
        {"7300021330000|640002042000064000204200006400020420000|6400020420000730002133000064000204200006400020420000", 8.50f, 1.97f},
        {"7300021320000|1440002044000014400020440000|6400020410000640002041000064000204100007300021320000640002041000064000204100006400020410000", 7.55f,
         0.00f},
        {"7300021320000|166000206220006400020421000|640002042100073000213200008200022201000820002220100064000204210008200022201000", 11.68f, 0.00f},
        {"7300021320000|64000204110006400020421000|7300021311000730002132000064000204110006400020421000", 6.60f, 0.25f},
        {"7300021311000|64000204110006400020421000|7300021311000730002132000064000204110006400020421000", 5.53f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002132000064000204210007300021330000", 8.77f, 0.00f},
        {"7300021320000|64000204100006400020421000|730002132000064000204110006400020411000", 4.85f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204110006400020420000", 5.51f, 0.38f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204100006400020421000", 7.14f, 0.57f},
        {"7300021311000|64000204110006400020421000|6400020421000730002131100064000204100006400020411000", 6.40f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204100006400020411000730002131100064000204100006400020411000", 6.04f, 1.39f},
        {"7300021311000|64000204110006400020411000|640002042100073000213110006400020421000", 6.15f, 0.00f},
        {"7300021311000|64000204210007300021311000|6400020411000640002042100073000213110006400020411000", 2.37f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002131100064000204110006400020421000", 3.43f, 0.00f},
        {"7300021311000|64000204110007300021311000|640002042100073000213110006400020411000", 3.47f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020421000730002131100064000204100007300021320000", 6.19f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204110006400020411000730002132000064000204100008200022201000", 0.50f, 0.00f},
        {"7300021320000|64000204200006400020421000|6400020421000730002132000064000204110006400020411000", 4.39f, 0.00f},
        {"7300021330000|640002041000064000204100006400020421000|730002133000064000204110006400020411000", 5.36f, 6.13f},
        {"7300021320000|64000204200006400020421000|6400020410000730002132000064000204110006400020411000", 5.12f, 0.00f},
        {"7300021310000|6400020421000|640002042100064000204210007300021310000", 6.94f, 3.05f},
        {"7300021310000|6400020420000|64000204300007300021310000", 9.70f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020411000730002131100073000213100007300021311000", 10.77f, 0.00f},
        {"7300021330000|640002041000064000204200006400020420000|730002133000064000204200006400020421000", 6.84f, 0.00f},
        {"7300021330000|640002041000064000204300006400020430000|73000213300006400020420000640002042000064000204200006400020420000", 6.75f, 2.95f},
        {"7300021320000|64000204200006400020430000|6400020420000730002132000064000204200006400020420000", 11.06f, 0.16f},
        {"7300021320000|64000204200006400020430000|6400020430000730002132000064000204200006400020420000", 10.30f, 0.00f},
        {"7300021320000|64000204100006400020430000|730002132000064000204100006400020420000", 10.99f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020421000730002131100064000204110006400020421000", 4.36f, 1.67f},
        {"7300021320000|64000204210006400020421000|64000204110006400020421000730002132000064000204110008200022201000", -0.31f, 0.00f},
        {"7300021320000|64000204110006400020421000|6400020411000730002132000064000204110006400020421000", 2.23f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204210006400020421000", 4.88f, 0.03f},
        {"7300021311000|64000204110006400020421000|7300021311000730002132000064000204210007300021311000", 8.20f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020421000730002131100064000204110007300021310000", 7.34f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204210007300021310000", 7.62f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020421000730002131100073000213200007300021320000", 4.48f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020421000730002131100064000204200007300021320000", 6.18f, 0.00f},
        {"7300021320000|64000204200006400020421000|6400020411000730002132000064000204110006400020411000", 4.17f, 0.00f},
        {"7300021320000|64000204210006400020430000|64000204110006400020411000730002132000064000204100006400020410000", 5.77f, 0.00f},
        {"7300021320000|64000204100006400020420000|73000213200006400020430000", 9.95f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204110007300021320000820002220100073000213300008200022201000", 9.50f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110007300021310000730002131100073000213300008200022201000", 4.25f, 0.03f},
        {"7300021310000|6400020430000|640002041000064000204300007300021310000", 9.32f, 0.12f},
        {"7300021311000|6400020421000|730002131100073000213110007300021330000", 4.61f, 0.00f},
        {"7300021320000|64000204400006400020440000|6400020410000640002041000064000204200007300021320000640002041000064000204100006400020420000", 11.07f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204100006400020411000730002131100064000204110006400020421000", 5.83f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002133000064000204210006400020421000", 9.12f, 0.00f},
        {"7300021311000|64000204110006400020421000|7300021311000730002131100064000204210007300021310000", 3.70f, 0.10f},
        {"7300021320000|64000204210006400020440000|640002041100064000204110007300021320000640002041000064000204100006400020410000", 7.00f, 0.00f},
        {"7300021330000|640002042000064000204200006400020421000|64000204100007300021330000640002041000064000204110006400020411000", 6.57f, 0.00f},
        {"7300021320000|64000204100006400020430000|730002132000064000204100006400020430000", 10.05f, 0.09f},
        {"7300021311000|64000204200006400020421000|6400020420000730002131100073000213100007300021320000", 9.58f, 0.00f},
        {"7300021310000|6400020430000|640002042000064000204400007300021310000", 10.17f, 0.00f},
        {"7300021330000|640002041000064000204400006400020440000|7300021330000640002041000064000204100006400020420000640002041000064000204100006400020420000",
         11.25f, 0.00f},
        {"7300021320000|64000204100006400020421000|730002132000064000204110006400020421000", 3.67f, 0.00f},
        {"7300021330000|640002041000064000204200006400020430000|7300021330000640002042000064000204210008200022210000", 11.38f, 0.00f},
        {"7300021311000|64000204110006400020420000|730002131100073000213200006400020430000", 5.20f, 0.00f},
        {"7300021330000|640002042000064000204200006400020421000|64000204100007300021330000640002041000064000204110006400020421000", 7.24f, 0.00f},
        {"7300021320000|64000204200006400020430000|6400020430000730002132000064000204100006400020410000", 9.12f, 0.48f},
        {"7300021311000|64000204210006400020430000|73000213100007300021311000730002132000064000204300008200022210000", 8.76f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020421000730002131100064000204110006400020421000", 5.48f, 4.28f},
        {"7300021320000|64000204210006400020421000|64000204110006400020411000730002132000064000204110006400020411000", 0.79f, 0.00f},
        {"7300021330000|640002041000064000204100006400020421000|730002133000064000204110006400020421000", 4.83f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110007300021311000730002132000073000213300008200022201000", 6.90f, 0.00f},
        {"7410020410000|6400020430000|640002042000064000204210007410020410000", 8.86f, 0.00f},
        {"7300021330000|640002042100064000204210008200022210000|64000204110006400020430000730002133000064000204210008200022201000", 5.50f, 0.00f},
        {"7300021311000|64000204210006400020421000|162000222200006400020420000730002131100064000204110006400020420000", 2.10f, 0.00f},
        {"7300021320000|64000204300006400020430000|64000204200006400020420000730002132000064000204200006400020420000", 10.40f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020421000730002131100064000204210007300021320000", 5.23f, 0.00f},
        {"7300021320000|64000204200006400020421000|6400020420000730002132000064000204100006400020421000", 4.20f, 0.00f},
        {"7300021311000|64000204210006400020440000|640002042100073000213110007300021320000640002041000064000204210006400020430000", 2.00f, 0.10f},
        {"7300021320000|64000204100006400020440000|7300021320000640002042000064000204210006400020421000", 7.50f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204110006400020440000730002131100064000204110006400020440000", 3.58f, 0.00f},
        {"7300021311000|64000204210006400020421000|64000204210007300021310000730002131100073000213100007300021311000", 6.60f, 0.00f},
        {"7300021320000|64000204200006400020430000|6400020420000730002132000064000204200006400020430000", 8.90f, 0.00f},
        {"7300021330000|640002041000064000204210006400020421000|73000213300006400020411000640002042100064000204200008200022201000", 3.40f, 0.00f},
        {"7300021311000|64000204100006400020421000|730002131100064000204200007300021311000", 4.80f, 0.00f},
        {"7300021330000|640002041000064000204200006400020430000|7300021330000640002043000064000204200006400020421000", 7.35f, 0.55f},
        {"7300021310000|6400020430000|640002042100064000204210007300021310000", 7.28f, 0.02f},
        {"7300021330000|640002041000064000204200006400020430000|7300021330000640002042000064000204200006400020421000", 6.53f, 0.47f},
        {"7300021330000|640002042000064000204200006400020421000|64000204200007300021330000640002042000064000204110008200022201000", 12.22f, 0.00f},
        {"7300021330000|640002041000064000204200006400020430000|7300021330000640002042000064000204200006400020430000", 9.03f, 0.82f},
        {"7300021330000|640002042000064000204210006400020421000|640002043000073000213300006400020411000640002042100064000204210007300021311000", 1.70f, 0.00f},
        {"7300021320000|64000204200006400020440000|64000204300007300021320000640002041000064000204100006400020410000", 9.67f, 0.00f},
        {"7300021330000|640002042100064000204210007300021330000|6400020411000640002041100073000213300006400020430000820002220100064000204210006400020421000",
         4.50f, 0.00f},
        {"7300021320000|64000204100006400020420000|73000213200006400020420000", 8.20f, 0.00f},
        {"7300021311000|64000204110006400020421000|6400020411000730002131100064000204200006400020421000", 6.40f, 0.00f},
        {"7300021320000|64000204210006400020421000|73000213100007300021311000730002132000064000204210007300021320000", 10.40f, 0.00f},
        {"7300021330000|640002041000064000204200006400020430000|7300021330000640002042000064000204210006400020430000", 7.80f, 0.00f},
        {"7300021330000|640002042100064000204210006400020430000|6400020411000640002042100073000213300006400020420000820002220100064000204300006400020440000",
         8.26f, 0.00f},
        {"7300021330000|640002042000064000204200006400020420000|6400020411000730002133000064000204200006400020420000", 7.64f, 0.00f},
        {"7300021320000|64000204210006400020430000|64000204100007300021320000820002220100064000204200006400020421000", 12.36f, 0.00f},
        {"7300021330000|640002042000064000204200006400020430000|64000204200007300021330000640002044000064000204400008200022220000", 12.20f, 0.00f},
        {"7300021330000|640002042000064000204200006400020420000|6400020410000730002133000064000204100006400020420000", 6.56f, 0.00f},
        {"7300021330000|640002042000064000204200006400020430000|64000204100007300021330000640002044000064000204300006400020440000", 7.70f, 1.82f},
        {"7300021330000|640002042000064000204200006400020430000|64000204200007300021330000640002043000064000204200006400020421000", 6.60f, 0.00f},
        {"7300021330000|640002042000064000204200006400020430000|64000204300007300021330000640002043000064000204200006400020440000", 9.54f, 0.00f},
        {"7300021330000|640002041000064000204100006400020430000|730002133000064000204200006400020430000", 8.80f, 0.00f},
        {"7300021320000|64000204110007300021330000|6400020421000730002132000064000204200006400020420000", 1.70f, 0.00f},
        {"7300021330000|640002042000064000204300006400020430000|640002043000073000213300006400020420000640002043000064000204200006400020430000", 6.66f, 0.00f},
        {"7300021330000|640002042000064000204200006400020430000|64000204110007300021330000640002042000064000204400006400020440000", 5.40f, 0.00f},
    };

    // these are Acids
    constexpr AdvancedPkaDef advanced_pka_model_acid[] = {
        {"8200022210000", 5.31f, 10.19f},
        {"7300021310000", 8.94f, 7.84f},
        {"6400020401000", 8.76f, 4.51f},
        {"6400020410000", 10.21f, 0.00f},
        {"16200022210000", 6.72f, 3.77f},
        {"6400020411000", 12.84f, 2.80f},
        {"7300021311000", 1.72f, 0.55f},
        {"6400020420000", 6.93f, 3.75f},
        {"33500020531000", 6.27f, 0.00f},
        {"7300021320000", 7.08f, 4.58f},
        {"82-10023110000", 3.06f, 1.23f},
        {"8200022210000|6400020421000", 4.82f, 5.80f},
        {"8200022210000|6400020410010", 3.70f, 0.00f},
        {"7300021310000|6400020410010", 1.10f, 0.00f},
        {"6400020401000|8200022201000", 13.27f, 0.00f},
        {"8200022210000|6400020411000", 3.75f, 0.00f},
        {"6400020410000|7410020421000", 10.21f, 0.00f},
        {"16200022210000|6400020421000", 4.30f, 2.32f},
        {"8200022210000|6400020410000", 10.33f, 0.00f},
        {"6400020411000|64000204400008200022201000", 10.04f, 0.00f},
        {"8200022210000|6400020420000", 13.56f, 1.94f},
        {"7300021311000|64000204110006400020411000", 2.27f, 0.00f},
        {"7300021311000|64000204110007300021320000", 1.17f, 0.00f},
        {"6400020411000|64000204100008200022201000", 13.57f, 0.00f},
        {"7300021310000|6400020421000", 14.05f, 1.05f},
        {"8200022210000|7300021320000", 8.70f, 0.00f},
        {"6400020420000|64000204100007410020421000", 8.46f, 0.00f},
        {"16200022210000|6400020420000", 9.14f, 0.87f},
        {"33500020531000|6400020410000640002041000082000222010008200022210000", 6.27f, 0.00f},
        {"8200022210000|16600020622000", 2.17f, 1.57f},
        {"6400020401000|6400020411000", 4.25f, 0.00f},
        {"8200022210000|7300021311000", 12.42f, 0.00f},
        {"8200022210000|6400020430000", 12.85f, 1.30f},
        {"7300021320000|64000204210006400020421000", 7.54f, 3.65f},
        {"7300021310000|16600020622000", 8.34f, 1.14f},
        {"7300021320000|64000204110006400020421000", 11.65f, 0.00f},
        {"7300021320000|64000204110006400020411000", 11.12f, 0.00f},
        {"82-10023110000|6400020421000", 3.06f, 1.23f},
        {"8200022210000|16400020421000", 1.30f, 0.00f},
        {"8200022210000|5300020330000", 8.83f, 0.00f},
        {"6400020420000|64000204210006400020421000", 6.55f, 4.13f},
        {"6400020411000|64000204110006400020411000", 14.90f, 0.00f},
        {"7300021320000|166000206220006400020421000", 5.42f, 2.92f},
        {"8200022210000|15500020531000", 6.30f, 0.10f},
        {"7300021320000|64000204210007300021330000", 3.60f, 0.00f},
        {"8200022210000|6400020421000|640002043000082000222010008200022210000", 2.97f, 2.02f},
        {"8200022210000|6400020421000|640002042000082000222010008200022210000", 3.90f, 2.42f},
        {"8200022210000|6400020410010|73000213000108200022210000", 3.70f, 0.00f},
        {"7300021310000|6400020410010|73000213000107300021310000", 1.10f, 0.00f},
        {"6400020401000|8200022201000|6400020401000", 13.27f, 0.00f},
        {"8200022210000|6400020411000|82000222010008200022210000", 3.75f, 0.00f},
        {"6400020410000|7410020421000|640002041000082-100231100008200022201000", 10.21f, 0.00f},
        {"16200022210000|6400020421000|16200022201000162000222100007300021310000", 2.95f, 0.00f},
        {"8200022210000|6400020410000|8200022210000", 10.33f, 0.00f},
        {"6400020411000|64000204400008200022201000|1710002311000017100023110000171000231100006400020411000", 10.04f, 0.00f},
        {"8200022210000|6400020421000|640002044000082000222010008200022210000", 2.93f, 3.71f},
        {"8200022210000|6400020421000|640002041100082000222010008200022210000", 4.31f, 1.13f},
        {"8200022210000|6400020420000|64000204400008200022210000", 12.31f, 0.07f},
        {"7300021311000|64000204110006400020411000|730002131100073000213110007300021320000", 2.27f, 0.00f},
        {"7300021311000|64000204110007300021320000|640002041100073000213110007300021311000", 1.17f, 0.00f},
        {"6400020411000|64000204100008200022201000|6400020411000", 13.57f, 0.00f},
        {"16200022210000|6400020421000|1620002221000064000204100008200022201000", 3.33f, 0.00f},
        {"8200022210000|6400020421000|640002041000082000222010008200022210000", 4.76f, 0.00f},
        {"7300021310000|6400020421000|640002041000073000213100008200022201000", 15.10f, 0.00f},
        {"8200022210000|7300021320000|64000204210008200022210000", 8.70f, 0.00f},
        {"6400020420000|64000204100007410020421000|640002042000082-100231100008200022201000", 8.46f, 0.00f},
        {"8200022210000|6400020420000|64000204100008200022210000", 15.50f, 0.00f},
        {"16200022210000|6400020420000|162000222100006400020420000", 9.00f, 0.73f},
        {"8200022210000|6400020420000|64000204200008200022210000", 14.60f, 0.70f},
        {"33500020531000|6400020410000640002041000082000222010008200022210000|33500020531000", 6.27f, 0.00f},
        {"8200022210000|16600020622000|6400020420000820002220100082000222010008200022210000", 1.45f, 0.05f},
        {"8200022210000|6400020421000|640002041001082000222010008200022210000", 2.23f, 0.39f},
        {"8200022210000|6400020420000|64000204100108200022210000", 13.60f, 0.00f},
        {"6400020401000|6400020411000|64000204010006400020421000", 4.25f, 0.00f},
        {"8200022210000|6400020421000|640002042100082000222010008200022210000", 3.50f, 2.85f},
        {"8200022210000|6400020420000|64000204110008200022210000", 15.50f, 0.00f},
        {"8200022210000|7300021311000|64000204210008200022210000", 12.42f, 0.00f},
        {"8200022210000|6400020430000|640002042000064000204200008200022210000", 14.15f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204200007300021320000820002220100073000213200008200022201000", 4.01f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204200007300021320000820002220100064000204200008200022201000", 9.62f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204210007300021320000820002220100073000213200008200022201000", 7.14f, 3.25f},
        {"7300021320000|64000204210006400020421000|64000204300007300021320000820002220100073000213200008200022201000", 8.96f, 0.00f},
        {"7300021310000|16600020622000|6400020421000730002131000082000222010008200022201000", 8.34f, 1.14f},
        {"8200022210000|6400020430000|640002042000064000204300008200022210000", 13.90f, 0.00f},
        {"7300021320000|64000204110006400020421000|6400020411000730002132000064000204110008200022201000", 11.65f, 0.00f},
        {"8200022210000|6400020421000|640002041100064000204110008200022210000", 9.19f, 2.04f},
        {"7300021320000|64000204110006400020411000|640002041100073000213200006400020411000", 11.12f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204400007300021320000820002220100082000222010008200022220000", 6.13f, 0.00f},
        {"8200022210000|6400020430000|640002042000082000222100008200022220000", 12.61f, 0.00f},
        {"8200022210000|6400020430000|640002041100064000204300008200022210000", 12.22f, 0.00f},
        {"8200022210000|6400020430000|640002043000082000222100008200022220000", 12.11f, 0.03f},
        {"82-10023110000|6400020421000|640002042000082-100231100008200022201000", 2.82f, 0.99f},
        {"8200022210000|6400020421000|640002042100064000204210008200022210000", 6.15f, 5.73f},
        {"8200022210000|6400020421000|640002041100064000204210008200022210000", 8.56f, 4.49f},
        {"8200022210000|16400020421000|640002042100082000222010008200022210000", 1.30f, 0.00f},
        {"8200022210000|16600020622000|6400020421000820002220100082000222010008200022210000", 2.53f, 1.83f},
        {"16200022210000|6400020421000|1620002221000064000204110006400020411000", 6.62f, 0.00f},
        {"8200022210000|5300020330000|640002042100082000222100008200022210000", 8.83f, 0.00f},
        {"6400020420000|64000204210006400020421000|64000204200006400020420000820002220100064000204200008200022201000", 5.20f, 0.06f},
        {"6400020420000|64000204210006400020421000|64000204200008200022201000820002222000082000222010008200022220000", 5.10f, 0.00f},
        {"6400020420000|64000204210006400020421000|64000204100006400020420000820002220100082000222010008200022220000", 10.68f, 0.00f},
        {"8200022210000|6400020420000|64000204300008200022210000", 12.81f, 0.90f},
        {"6400020411000|64000204110006400020411000|640002041100064000204110006400020411000", 14.90f, 0.00f},
        {"7300021310000|6400020421000|640002042100073000213100008200022201000", 13.00f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204210007300021320000820002220100073000213300008200022201000", 7.89f, 0.00f},
        {"16200022210000|6400020420000|162000222100006400020421000", 9.43f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204200007300021320000820002220100073000213300008200022201000", 7.20f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204110007300021320000820002220100073000213300008200022201000", 6.70f, 0.00f},
        {"7300021320000|64000204210006400020421000|64000204400007300021320000820002220100073000213200008200022201000", 7.72f, 0.29f},
        {"7300021320000|166000206220006400020421000|6400020421000730002132000082000222010008200022201000162000222200007300021311000", 7.20f, 0.00f},
        {"8200022210000|15500020531000|8200022201000820002221000082000222100008200022220000", 6.30f, 0.10f},
        {"7300021320000|64000204210006400020421000|64000204400007300021320000820002220100073000213300008200022201000", 8.45f, 0.00f},
        {"7300021320000|166000206220006400020421000|640002042100073000213200008200022201000820002220100064000204110007300021311000", 6.70f, 0.00f},
        {"7300021320000|166000206220006400020421000|640002044000073000213200008200022201000820002220100064000204110006400020421000", 3.55f, 1.05f},
        {"7300021320000|166000206220006400020421000|640002042100073000213200008200022201000820002220100064000204210008200022220000", 5.00f, 0.00f},
        {"7300021320000|166000206220006400020421000|640002042100073000213200008200022201000820002220100073000213110007300021311000", 7.40f, 0.00f},
        {"82-10023110000|6400020421000|640002043000082-100231100008200022201000", 3.40f, 0.00f},
        {"7300021320000|166000206220006400020421000|640002042100073000213200008200022201000820002220100064000204210008200022201000", 4.57f, 0.00f},
        {"7300021320000|64000204210007300021330000|73000213200007300021320000820002220100064000204200006400020420000", 3.60f, 0.00f},
        {"7300021320000|64000204210006400020421000|73000213110007300021320000820002220100064000204210008200022201000", 9.69f, 0.00f},
        {"82-10023110000|6400020421000|640002042100082-100231100008200022201000", 3.20f, 0.00f}};

    void LoadPkaDefToModel(RedBlackStringObjMap<Array<float>>& adv_model, const AdvancedPkaDef* from, const AdvancedPkaDef* const end)
    {
        adv_model.clear();
        for (; from < end; ++from)
        {
            if (adv_model.find(from->a_fp))
                adv_model.remove(from->a_fp);

            adv_model.insert(from->a_fp);
            adv_model.at(from->a_fp).push(from->pka);
            adv_model.at(from->a_fp).push(from->deviation);
        }
    }
} // namespace

void MoleculePkaModel::_loadAdvancedPkaModel()
{
    LoadPkaDefToModel(_model.adv_a_pkas, advanced_pka_model_acid, advanced_pka_model_acid + NELEM(advanced_pka_model_acid));
    LoadPkaDefToModel(_model.adv_b_pkas, advanced_pka_model_basic, advanced_pka_model_basic + NELEM(advanced_pka_model_basic));
    _model.advanced_model_ready = true;
}

void MoleculePkaModel::_estimate_pKa_Simple(Molecule& mol, const IonizeOptions& options, Array<int>& acid_sites, Array<int>& basic_sites,
                                            Array<float>& acid_pkas, Array<float>& basic_pkas)
{
    //   QS_DEF(Array<int>, can_order);
    //   QS_DEF(Molecule, can_mol);
    QS_DEF(Array<int>, ignore_atoms);
    QS_DEF(Array<int>, mapping);
    AromaticityOptions opts;

    //   _checkCanonicalOrder(mol, can_mol, can_order);

    if (!mol.isAromatized())
    {
        mol.aromatize(opts);
    }

    MoleculeSubstructureMatcher matcher(mol);
    matcher.fmcache = new MoleculeSubstructureMatcher::FragmentMatchCache;
    matcher.use_aromaticity_matcher = true;
    ignore_atoms.clear();
    for (auto i = 0; i < _model.acids.size(); ++i)
    {
        matcher.setQuery(_model.acids[i]);

        for (int j = 0; j < ignore_atoms.size(); ++j)
            matcher.ignoreTargetAtom(ignore_atoms[j]);

        for (bool flag = matcher.find(); flag; flag = matcher.findNext())
        {
            mapping.clear();
            mapping.copy(matcher.getQueryMapping(), _model.acids[i].vertexEnd());
            for (int j = 0; j < mapping.size(); ++j)
            {
                if (mapping[j] > -1)
                {
                    acid_sites.push(mapping[j]);
                    acid_pkas.push(_model.a_pkas[i]);
                    ignore_atoms.push(mapping[j]);
                }
            }
        }
    }

    ignore_atoms.clear();
    for (auto i = 0; i < _model.basics.size(); ++i)
    {
        matcher.setQuery(_model.basics[i]);

        for (int j = 0; j < ignore_atoms.size(); ++j)
            matcher.ignoreTargetAtom(ignore_atoms[j]);

        for (bool flag = matcher.find(); flag; flag = matcher.findNext())
        {
            mapping.clear();
            mapping.copy(matcher.getQueryMapping(), _model.basics[i].vertexEnd());
            for (int j = 0; j < mapping.size(); ++j)
            {
                if (mapping[j] > -1)
                {
                    basic_sites.push(mapping[j]);
                    basic_pkas.push(_model.b_pkas[i]);
                    ignore_atoms.push(mapping[j]);
                }
            }
        }
    }
}

void MoleculePkaModel::_estimate_pKa_Advanced(Molecule& mol, const IonizeOptions& options, Array<int>& acid_sites, Array<int>& basic_sites,
                                              Array<float>& acid_pkas, Array<float>& basic_pkas)
{
    //   QS_DEF(Array<int>, can_order);
    //   QS_DEF(Molecule, can_mol);
    AromaticityOptions opts;
    int level = options.level;
    int min_level = options.min_level;

    //   _checkCanonicalOrder(mol, can_mol, can_order);

    for (auto i : mol.vertices())
    {
        int a_lone = 0;
        mol.getVacantPiOrbitals(i, &a_lone);
        int a_hcnt = mol.getAtomTotalH(i);

        if (a_hcnt > 0)
        {
            float a_pka = getAcidPkaValue(mol, i, level, min_level);
            acid_sites.push(i);
            acid_pkas.push(a_pka);
            //         printf("Acid site: atom index = %d, pKa = %f\n",  can_order[i], a_pka);
        }

        if (a_lone > 0)
        {
            float b_pka = getBasicPkaValue(mol, i, level, min_level);
            basic_sites.push(i);
            basic_pkas.push(b_pka);
            //         printf("Basic site: atom index = %d, pKa = %f\n",  can_order[i], b_pka);
        }
    }
}

int MoleculePkaModel::_asc_cmp_cb(int& v1, int& v2, void* context)
{
    Array<char> key1;
    Array<char> key2;

    Molecule& mol = *(Molecule*)context;
    getAtomLocalKey(mol, v1, key1);
    getAtomLocalKey(mol, v2, key2);

    if (!key1.ptr())
        return 1; // we could get nullptr for H; H must be last in sorted atoms; H always bigger
    if (!key2.ptr())
        return -1; // we could get nullptr for H; H must be last in sorted atoms; H always bigger

    const int res = strcmp(key1.ptr(), key2.ptr());
    if (res != 0)
        return res;

    const Vertex& v3 = mol.getVertex(v1);
    for (auto i : v3.neighbors())
    {
        getAtomLocalKey(mol, v3.neiVertex(i), key1);
    }

    const Vertex& v4 = mol.getVertex(v2);
    for (auto i : v4.neighbors())
    {
        getAtomLocalKey(mol, v4.neiVertex(i), key2);
    }
    return strcmp(key1.ptr(), key2.ptr());
}

void MoleculePkaModel::getAtomLocalFingerprint(Molecule& mol, int idx, Array<char>& fp, int level)
{
    QS_DEF(Array<int>, included_atoms);
    QS_DEF(Array<int>, dist_atoms);
    QS_DEF(Queue<int>, bfs_queue);

    QS_DEF(Array<char>, n_key);
    QS_DEF(Array<char>, bond);

    QS_DEF(Array<int>, neibs_atoms);
    QS_DEF(Array<int>, neibs_bonds);

    fp.clear();
    bfs_queue.setLength(mol.vertexEnd());
    bfs_queue.clear();
    included_atoms.clear();
    dist_atoms.clear_resize(mol.vertexEnd());
    dist_atoms.zerofill();

    n_key.clear();
    getAtomLocalKey(mol, idx, n_key);
    if (n_key.size() != 0)
        fp.appendString(n_key.ptr(), true);

    if (level == 0)
    {
        return;
    }
    else
    {
        int cur_level = 0;
        // Mark new layer after root atom
        fp.appendString("|", true);
        bfs_queue.push(idx);

        while (!bfs_queue.isEmpty())
        {
            int next = bfs_queue.pop();
            int dist = dist_atoms.at(next);
            if (dist == level)
                continue;
            if (dist > cur_level)
            {
                cur_level = dist;
                // Mark next new layer
                fp.appendString("|", true);
            }

            const Vertex& v = mol.getVertex(next);

            neibs_atoms.clear();
            neibs_bonds.clear();

            for (auto i : v.neighbors())
            {
                neibs_atoms.push(v.neiVertex(i));
            }
            neibs_atoms.qsort(_asc_cmp_cb, &mol);

            for (auto i = 0; i < neibs_atoms.size(); i++)
            {
                for (auto j : v.neighbors())
                {
                    if (neibs_atoms[i] == v.neiVertex(j))
                        neibs_bonds.push(v.neiEdge(j));
                }
            }

            //         for (auto i : v.neighbors())
            for (auto i = 0; i < neibs_atoms.size(); i++)
            {
                if (included_atoms.find(neibs_atoms[i]) == -1)
                {
                    bfs_queue.push(neibs_atoms[i]);
                    included_atoms.push(neibs_atoms[i]);
                    dist_atoms[neibs_atoms[i]] = dist + 1;
                    bond.clear();
                    ArrayOutput tmp(bond);
                    n_key.clear();
                    getAtomLocalKey(mol, neibs_atoms[i], n_key);
                    if (n_key.size() == 0)
                        continue;

                    //               int order = mol.getBondOrder(neibs_bonds[i]);
                    //               tmp.printf(":%d:", order);
                    //               tmp.writeChar(0);

                    //               fp.appendString(bond.ptr(), true);
                    fp.appendString(n_key.ptr(), true);
                }
            }
        }
        // Remove empty layer, if it was created
        if (fp[fp.size() - 2] == '|')
            fp.remove(fp.size() - 2);
    }
    return;
}

void MoleculePkaModel::_removeExtraHydrogens(Molecule& mol)
{
    QS_DEF(Array<int>, to_remove);

    to_remove.clear();
    for (auto i : mol.vertices())
        if (mol.convertableToImplicitHydrogen(i))
            to_remove.push(i);

    if (to_remove.size() > 0)
        mol.removeAtoms(to_remove);
}

void MoleculePkaModel::_checkCanonicalOrder(Molecule& mol, Molecule& can_mol, Array<int>& order)
{
    QS_DEF(Array<int>, to_remove);
    QS_DEF(Array<int>, ignored);

    ignored.clear_resize(mol.vertexEnd());
    ignored.zerofill();
    to_remove.clear();

    for (auto i : mol.vertices())
        if (mol.convertableToImplicitHydrogen(i))
            to_remove.push(i);

    if (to_remove.size() > 0)
        mol.removeAtoms(to_remove);

    MoleculeAutomorphismSearch as;

    as.detect_invalid_cistrans_bonds = false;
    as.detect_invalid_stereocenters = false;
    as.find_canonical_ordering = true;
    as.ignored_vertices = ignored.ptr();
    as.process(mol);
    as.getCanonicalNumbering(order);
    can_mol.makeSubmolecule(mol, order, NULL);

    //   printMolfile(mol);
    //   printMolfile(can_mol);
}

void MoleculePkaModel::getAtomLocalKey(Molecule& mol, int idx, Array<char>& fp)
{
    QS_DEF(Array<int>, feature_set);
    if (!getAtomLocalFeatureSet(mol, idx, feature_set))
        return;

    QS_DEF(Array<char>, key);
    key.clear();
    ArrayOutput output(key);

    for (int i = 0; i < feature_set.size(); i++)
        output.printf("%d", feature_set[i]);

    output.writeChar(0);

    fp.appendString(key.ptr(), true);
}

/**
 * Writes atom features to `fp`:
 *   0. atom number
 *   1. atom valence
 *   2. atom charge
 *   3. atom radical
 *   4. atom isotope
 *   5. atom aromaticity
 *   6. lone pair count
 *   7. connectivity
 *   8. single bond count
 *   9. double bond count
 *  10. aromatic bond count
 *  11. triple bond count
 *  12. zero bond count
 * */
bool MoleculePkaModel::getAtomLocalFeatureSet(BaseMolecule& mol, int idx, Array<int>& fp)
{
    if (mol.isPseudoAtom(idx) || mol.isRSite(idx) || mol.isTemplateAtom(idx))
    {
        QS_DEF(Array<char>, a_desc);
        mol.getAtomDescription(idx, a_desc);
        throw Error("pKa model can't used with atom : %s", a_desc.ptr());
    }

    int a_num = mol.getAtomNumber(idx);
    // Just bypass the hyfrogen atom
    if (a_num == ELEM_H)
        return false;

    int a_val = mol.getAtomValence(idx);
    int a_chg = mol.getAtomCharge(idx);
    int a_rad = mol.getAtomRadical(idx);
    int a_iso = mol.getAtomIsotope(idx);
    int a_arom = mol.getAtomAromaticity(idx);
    int a_conn = mol.getAtomConnectivity(idx);

    int a_lone = 0;
    int group = Element::group(mol.getAtomNumber(idx));

    try
    {
        mol.getVacantPiOrbitals(group, a_chg, a_rad, a_conn, &a_lone);
    }
    catch (indigo::Exception&)
    {
        a_lone = -1; // The atom is aromatic
    }

    mol.getAtomTotalH(idx);

    int a_single_cnt = 0;
    int a_double_cnt = 0;
    int a_aromatic_cnt = 0;
    int a_triple_cnt = 0;
    int a_coord_cnt = 0;

    const Vertex& vertex = mol.getVertex(idx);
    for (auto i : vertex.neighbors())
    {
        int order = mol.getBondOrder(vertex.neiEdge(i));

        if (order == BOND_SINGLE)
            a_single_cnt++;
        else if (order == BOND_DOUBLE)
            a_double_cnt++;
        else if (order == BOND_AROMATIC)
            a_aromatic_cnt++;
        else if (order == BOND_TRIPLE)
            a_triple_cnt++;
        else if (order == BOND_ZERO)
            a_coord_cnt++;
    }

    int feature_set[] = {a_num, a_val, a_chg, a_rad, a_iso, a_arom, a_lone, a_conn, a_single_cnt, a_double_cnt, a_aromatic_cnt, a_triple_cnt, a_coord_cnt};

    fp.copy(feature_set, sizeof(feature_set) / sizeof(*feature_set));

    return true;
}

float MoleculePkaModel::getAcidPkaValue(Molecule& mol, int idx, int level, int min_level)
{
    QS_DEF(Array<char>, fp);
    QS_DEF(Array<int>, level_pos);
    fp.clear();
    level_pos.clear();
    float pka = 100.f;

    int a_num = mol.getAtomNumber(idx);
    if (a_num == ELEM_H)
        return pka;

    getAtomLocalFingerprint(mol, idx, fp, level);
    //   printf("Acid site: atom index = %d, fp = %s\n",  idx, fp.ptr());

    if (_model.adv_a_pkas.find(fp.ptr()))
    {
        pka = _model.adv_a_pkas.at(fp.ptr())[0];
        //      printf("Acid site found: fp = %s  level = %d pka = %4.2f, dev = %4.2f\n",  fp.ptr(), level, pka,
        //             _model.adv_a_pkas.at(fp.ptr())[1]);
    }
    else
    {
        int levels = fp.count('|');
        int beg = 0;
        int end = fp.size();
        for (int i = 0; i < levels; i++)
        {
            beg = fp.find(beg + 1, end, '|');
            level_pos.push(beg);
        }

        for (int i = 0; i < level_pos.size(); i++)
        {
            if ((level_pos.size() - i - 1) < min_level)
                break;
            int next_layer = level_pos[level_pos.size() - i - 1];
            fp.remove(next_layer, fp.size() - next_layer - 1);

            //         printf("Try FP = %s level = %d\n", fp.ptr(), level_pos.size() - i);

            if (_model.adv_a_pkas.find(fp.ptr()))
            {
                pka = _model.adv_a_pkas.at(fp.ptr())[0];
                //            printf("Acid site found: fp = %s level = %d pka = %4.2f, dev = %4.2f\n", fp.ptr(), level_pos.size() - i, pka,
                //                   _model.adv_a_pkas.at(fp.ptr())[1]);
                break;
            }
        }
    }

    return pka;
}

float MoleculePkaModel::getBasicPkaValue(Molecule& mol, int idx, int level, int min_level)
{
    QS_DEF(Array<char>, fp);
    QS_DEF(Array<int>, level_pos);
    fp.clear();
    level_pos.clear();
    float pka = -100.f;

    int a_num = mol.getAtomNumber(idx);
    if (a_num == ELEM_H)
        return pka;

    getAtomLocalFingerprint(mol, idx, fp, level);
    //   printf("Basic site: atom index = %d, fp = %s\n",  idx, fp.ptr());

    if (_model.adv_b_pkas.find(fp.ptr()))
    {
        pka = (_model.adv_b_pkas.at(fp.ptr())[0]);
        //      printf("Basic site found: fp = %s  pka = %4.2f, dev = %4.2f\n",  fp.ptr(), pka,
        //              _model.adv_b_pkas.at(fp.ptr())[1]);
    }
    else
    {
        int levels = fp.count('|');
        int beg = 0;
        int end = fp.size();
        for (int i = 0; i < levels; i++)
        {
            beg = fp.find(beg + 1, end, '|');
            level_pos.push(beg);
        }

        for (int i = 0; i < level_pos.size(); i++)
        {
            if ((level_pos.size() - i - 1) < min_level)
                break;
            int next_layer = level_pos[level_pos.size() - i - 1];
            fp.remove(next_layer, fp.size() - next_layer - 1);
            if (_model.adv_b_pkas.find(fp.ptr()))
            {
                pka = _model.adv_b_pkas.at(fp.ptr())[0];
                //            printf("Basic site found: fp = %s  level = %d pka = %4.2f, dev = %4.2f\n",  fp.ptr(), level_pos.size() - i, pka,
                //                   _model.adv_b_pkas.at(fp.ptr())[1]);
                break;
            }
        }
    }

    return pka;
}

IMPL_ERROR(MoleculeIonizer, "Molecule Ionizer");

CP_DEF(MoleculeIonizer);
MoleculeIonizer::MoleculeIonizer() : CP_INIT
{
}

bool MoleculeIonizer::ionize(Molecule& mol, float ph, float ph_toll, const IonizeOptions& options)
{
    QS_DEF(Array<int>, acid_sites);
    QS_DEF(Array<int>, basic_sites);
    QS_DEF(Array<float>, acid_pkas);
    QS_DEF(Array<float>, basic_pkas);

    acid_sites.clear();
    basic_sites.clear();
    acid_pkas.clear();
    basic_pkas.clear();

    MoleculePkaModel::estimate_pKa(mol, options, acid_sites, basic_sites, acid_pkas, basic_pkas);

    if (acid_sites.size() > 0 || basic_sites.size() > 0)
        _setCharges(mol, ph, ph_toll, options, acid_sites, basic_sites, acid_pkas, basic_pkas);

    return true;
}

void MoleculeIonizer::_setCharges(Molecule& mol, float pH, float pH_toll, const IonizeOptions& options, Array<int>& acid_sites, Array<int>& basic_sites,
                                  Array<float>& acid_pkas, Array<float>& basic_pkas)
{
    for (auto i = 0; i < acid_sites.size(); i++)
    {
        if ((acid_pkas[i] - pH) < pH_toll)
        {
            mol.setAtomCharge(acid_sites[i], mol.getAtomCharge(acid_sites[i]) - 1);
            //         printf("Acid site: atom index = %d, pKa = %f\n",  acid_sites[i], acid_pkas[i]);
        }
    }

    for (auto i = 0; i < basic_sites.size(); i++)
    {
        if ((basic_pkas[i] - pH) > -pH_toll)
        {
            mol.setAtomCharge(basic_sites[i], mol.getAtomCharge(basic_sites[i]) + 1);
            //         printf("Basic site: atom index = %d, pKa = %f\n",  basic_sites[i], basic_pkas[i]);
        }
    }
}
